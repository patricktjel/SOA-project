<?xml version="1.0" encoding="UTF-8"?>
<bpel:process exitOnStandardFault="yes" name="orchestrator.bpel"
	suppressJoinFailure="yes" targetNamespace="http://www.example.org/orchestrator"
	xmlns:bpel="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
	xmlns:orc="http://www.example.org/orchestrator" 
	xmlns:inv="http://www.example.org/inventory"
	xmlns:del="http://www.example.org/delivery"
	xmlns:tra="http://www.example.org/rentalTracking"
	xmlns:bil="http://www.example.org/billing">
	
	<bpel:import importType="http://schemas.xmlsoap.org/wsdl/"
		location="orchestrator.wsdl" namespace="http://www.example.org/orchestrator" />
	<bpel:import importType="http://schemas.xmlsoap.org/wsdl/"
		location="Inventory.wsdl" namespace="http://www.example.org/inventory" />
	<bpel:import importType="http://schemas.xmlsoap.org/wsdl/"
		location="Delivery.wsdl" namespace="http://www.example.org/delivery" />
	<bpel:import importType="http://schemas.xmlsoap.org/wsdl/"
		location="Billing.wsdl" namespace="http://www.example.org/billing" />
	<bpel:import importType="http://schemas.xmlsoap.org/wsdl/"
		location="RentalTracking.wsdl" namespace="http://www.example.org/rentalTracking" />

	<bpel:partnerLinks>
		<bpel:partnerLink name="customer" partnerLinkType="orc:OrchestratorPLT" myRole="orchestratorService"/>
        <bpel:partnerLink name="inventory" partnerLinkType="inv:InventoryPLT" partnerRole="InventoryService"/>
        <bpel:partnerLink name="delivery" partnerLinkType="del:DeliveryPLT" partnerRole="DeliveryService"/>
        <bpel:partnerLink name="billing" partnerLinkType="bil:BillingPLT" partnerRole="BillingService"/>
<!-- 	<bpel:partnerLink name="tracking" partnerLinkType="tra:TrackingPLT" partnerRole="TrackingService"/> -->        
    </bpel:partnerLinks>

	<bpel:variables>
		<bpel:variable name="rentIceSkatesRequest" messageType="orc:rentIceSkatesRequest" />
		<bpel:variable name="rentIceSkatesResponse" messageType="orc:rentIceSkatesResponse" />
		
		<bpel:variable name="getPairOfSkatesRequest" messageType="inv:getPairOfSkatesRequest" />
		<bpel:variable name="getPairOfSkatesResponse" messageType="inv:getPairOfSkatesResponse" />
		<bpel:variable name="returnPairOfSkates" messageType="inv:returnPairOfSkates" />
		
		<bpel:variable name="requestDelivery" messageType="del:requestDelivery" />
		
		<bpel:variable name="paymentRequest" messageType="bil:paymentRequest" />
		<bpel:variable name="paymentResponse" messageType="bil:paymentResponse" />
		
		<bpel:variable name="trackIceSkatesRequest" messageType="tra:trackIceSkatesRequest" />
	</bpel:variables>
    
    <bpel:flow name="main"><bpel:links>
        	<bpel:link name="link1"></bpel:link>
            <bpel:link name="link2"></bpel:link>
            <bpel:link name="link3"></bpel:link>
            <bpel:link name="link5"></bpel:link>
            
            <bpel:link name="link7"></bpel:link>
            
            
            
            
            
            
            
            <bpel:link name="link4"></bpel:link>
            <bpel:link name="link6"></bpel:link>
        </bpel:links>
        
        <bpel:receive name="Receive" partnerLink="customer" operation="rentIceSkates" portType="orc:OrchestratorPortType" createInstance="yes" variable="rentIceSkatesRequest">
            <bpel:sources>
                <bpel:source linkName="link1"></bpel:source>
            </bpel:sources>
        </bpel:receive>
    
        <bpel:sequence name="InventorySequence">
        	<bpel:targets>
                <bpel:target linkName="link1"></bpel:target>
            </bpel:targets>
            <bpel:sources>
                <bpel:source linkName="link2">
                	<bpel:transitionCondition>
						$getPairOfSkatesResponse.availability != "true"
					</bpel:transitionCondition>
                </bpel:source>
                <bpel:source linkName="link4">
                    <bpel:transitionCondition>
						$getPairOfSkatesResponse.availability = "true"
					</bpel:transitionCondition>
                </bpel:source>
            </bpel:sources>
            <bpel:assign validate="no" name="Assign"><bpel:copy><bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$rentIceSkatesRequest.size]]>
                    </bpel:from>
                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$getPairOfSkatesRequest.size]]>
                    </bpel:to>
                
                </bpel:copy>
            
            </bpel:assign>
            <bpel:invoke name="Invoke" partnerLink="inventory" operation="inventory" portType="inv:inventoryPortType" inputVariable="getPairOfSkatesRequest" outputVariable="getPairOfSkatesResponse"></bpel:invoke>
        </bpel:sequence>
    
    
    <bpel:reply name="Reply" partnerLink="customer" operation="rentIceSkates" portType="orc:OrchestratorPortType" variable="rentIceSkatesResponse">
            <bpel:targets>
                <bpel:target linkName="link3"></bpel:target>
                
                <bpel:target linkName="link5"></bpel:target>
            </bpel:targets>
        </bpel:reply><bpel:assign validate="no" name="Assign1">
            <bpel:targets>
                <bpel:target linkName="link2"></bpel:target>
            </bpel:targets>
            <bpel:sources>
                <bpel:source linkName="link3"></bpel:source>
            </bpel:sources>
            <bpel:copy>
                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$getPairOfSkatesResponse.availability]]>
                </bpel:from>
                <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$rentIceSkatesResponse.succeeded]]>
                </bpel:to>
            </bpel:copy>
        </bpel:assign>    <bpel:assign validate="no" name="Assign2">
            <bpel:sources>
                <bpel:source linkName="link5"></bpel:source>
            </bpel:sources>
            <bpel:copy>
                <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$paymentResponse.succeeded]]>
                </bpel:from>
                <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                    <![CDATA[$rentIceSkatesResponse.succeeded]]>
                </bpel:to>
            </bpel:copy>
            <bpel:targets>
                <bpel:target linkName="link7"></bpel:target>
            </bpel:targets>
        </bpel:assign>
    <bpel:sequence name="DeliverySequence">
            <bpel:assign validate="yes" name="Assign3">
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$getPairOfSkatesResponse.iceSkatesID]]>
                    </bpel:from>
                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$requestDelivery.iceSkatesID]]>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$rentIceSkatesRequest.customer]]>
                    </bpel:from>
                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$requestDelivery.customer]]>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$getPairOfSkatesResponse.iceSkatesID]]>
                    </bpel:from>
                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$requestDelivery.deliveryID]]>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from part="size" variable="getPairOfSkatesRequest"></bpel:from>
                    <bpel:to part="callbackURL" variable="requestDelivery"></bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from part="size" variable="getPairOfSkatesRequest"></bpel:from>
                    <bpel:to part="weight" variable="requestDelivery"></bpel:to>
                </bpel:copy>
            </bpel:assign>
            
            <bpel:invoke name="Invoke1" partnerLink="delivery" operation="delivery" portType="del:deliveryPortType" inputVariable="requestDelivery"></bpel:invoke>
            <bpel:targets>
                <bpel:target linkName="link4"></bpel:target>
            </bpel:targets>
            <bpel:sources>
                <bpel:source linkName="link6"></bpel:source>
            </bpel:sources>
        </bpel:sequence>
        <bpel:sequence name="billing_service">
            
            
            <bpel:assign validate="no" name="Assign4"><bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$rentIceSkatesRequest.customer]]>
                    </bpel:from>
                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$paymentRequest.customer]]>
                    </bpel:to>
                </bpel:copy>
                <bpel:copy>
                    <bpel:from expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$getPairOfSkatesResponse.price]]>
                    </bpel:from>
                    <bpel:to expressionLanguage="urn:oasis:names:tc:wsbpel:2.0:sublang:xpath1.0">
                        <![CDATA[$paymentRequest.totalprice]]>
                    </bpel:to>
                </bpel:copy>
            
            </bpel:assign>
            <bpel:invoke name="Invoke2" partnerLink="billing" operation="payment" portType="bil:paymentPortType" inputVariable="paymentRequest" outputVariable="paymentResponse"></bpel:invoke>
            <bpel:sources>
                <bpel:source linkName="link7"></bpel:source>
            </bpel:sources>
            <bpel:targets>
                <bpel:target linkName="link6"></bpel:target>
            </bpel:targets>
        </bpel:sequence></bpel:flow>
</bpel:process>
